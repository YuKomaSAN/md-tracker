# MD Tracker システム仕様書

## 1. プロジェクト概要

**名称:** MD Tracker (Master Duel Tracker)  
**バージョン:** v4.2 (Current)  
**目的:** 遊戯王マスターデュエルの対戦画面をブラウザ経由でキャプチャし、OCR（光学文字認識）を用いて「コイントス結果」「手番」「勝敗」「対戦時間」を自動でGoogleスプレッドシートに記録・分析するツール。

---

## 2. システムアーキテクチャ

### 2.1. 構成図

```
[PC / Browser] <--(Screen Share)-- [Master Duel Game Window]
      |
      +-- [Frontend (HTML/CSS/JS)]
      |      |-- Tesseract.js (OCR Engine)
      |      |-- Canvas API (Image Processing)
      |      +-- LocalStorage (Config Save)
      |
      +--(JSONP Request)--> [Backend (Google Apps Script)]
                                   |
                                   +--> [Database (Google Sheets)]
```

### 2.2. 技術スタック

- **Frontend:** HTML5, CSS3, Vanilla JavaScript
- **OCR Library:** Tesseract.js v4 (WebAssembly)
- **Backend:** Google Apps Script (GAS)
- **Database:** Google Sheets
- **Dev Tools:** VS Code, Git/GitHub, CLASP (Command Line Apps Script Projects)

---

## 3. 機能要件

### 3.1. 自動記録機能

- **コイントス判定:**
    - 画面下部のメッセージウィンドウを監視し、「先攻・後攻を選択」「相手が選択」等のキーワードから、コインの表裏と手番を自動判定。
    - 判定と同時に試合タイマーを開始。
- **勝敗判定:**
    - 画面中央に表示される「VICTORY」「LOSE」等の文字を検知。
    - 誤検知防止のため、特定のキーワード（CLOSE等）は除外。
- **時間計測:**
    - 試合開始（コイントス確定）から決着までの時間を計測し、秒数で記録。

### 3.2. データ管理機能

- **履歴表示:** 最新100件の対戦履歴を表形式で表示。
- **編集・削除:** 記録されたデータの修正（デッキ変更、勝敗修正）および削除が可能。
- **デッキ管理:**
    - 「使用デッキ」「対戦相手のデッキ」をプルダウン選択。
    - 新規デッキ名をその場で追加登録可能。

### 3.3. 分析機能

- **ダッシュボード:**
    - 総試合数、勝率、コイントス表率、平均試合時間を表示。
    - 「セッション集計」機能により、ボタンを押した時点からの成績のみを表示可能。
- **詳細フィルター:**
    - 期間（1時間、24時間、週間、月間、全期間、カスタム日時指定）。
    - 対戦種別（ランクマ、レート、DC/WCS、その他）。
    - フィルター条件の保存機能。
- **デッキ別勝率:** 使用デッキ別、対戦相手デッキ別の勝率テーブルを表示。

### 3.4. UI/UX機能

- **映像モニタ:** AIが認識している映像（白黒二値化・クロップ済み）をリアルタイムで確認可能。
- **Picture-in-Picture (PiP):**
    - 操作パネルとステータス表示を独立した「縦型ミニウィンドウ」に分離。
    - ゲーム画面の横に配置しての「ながら作業」に対応。
    - メイン画面とミニウィンドウは完全同期。

---

## 4. データ構造 (Google Sheets)

### 4.1. シート名: `Log` (対戦ログ)

| 列 | 項目名 | データ型 | 説明 |
|:---|:---|:---|:---|
| A | 開始日時 | DateTime | 試合開始時刻 (yyyy/MM/dd HH:mm:ss) |
| B | 終了日時 | DateTime | 試合終了時刻 |
| C | 時間 | Number | 試合時間（秒数） |
| D | 自分デッキ | String | 使用したデッキ名 |
| E | コイン | String | 表 / 裏 |
| F | 手番 | String | 先攻 / 後攻 |
| G | 勝敗 | String | WIN / LOSE |
| H | 相手デッキ | String | 対戦相手のデッキ名 |
| I | 対戦種別 | String | ランクマッチ / レート / etc |

### 4.2. シート名: `Config` (設定マスタ)

| 列 | 項目名 | データ型 | 説明 |
|:---|:---|:---|:---|
| A | デッキリスト | String | 選択肢に表示するデッキ名一覧 |

---

## 5. ロジック仕様

### 5.1. 画像処理 (Canvas)

認識精度を高めるため、状態に応じてキャプチャ領域と画質設定を動的に切り替える。

| 状態 | クロップ領域 (ROI) | 明るさ閾値 | コントラスト | 狙い |
|:---|:---|:---|:---|:---|
| **待機中** | 画面中央下 (Top:63%, H:10%) | 72 (暗め) | 105 (強) | コイントスボタン、メッセージ |
| **試合中** | 画面中央 (Top:33%, H:34%) | 172 (明るめ) | 0 (なし) | VICTORY / LOSE ロゴ |

### 5.2. 判定ワード

| 判定 | トリガーキーワード (部分一致含む) | 挙動 |
|:---|:---|:---|
| **コイン裏** | `相手`, `対戦` かつ `選択` | 即時試合開始、手番「後攻」セット |
| **コイン表** | `選択`, `先攻`, `後攻`, `ださい` | 即時試合開始、手番「先攻」セット |
| **補正** | `あなたが先攻`, `あなたが後攻` | コイントス見逃し時のバックアップ |
| **勝利** | `VICTORY`, `VICTDRY`, `VICT0RY`, `VIGTORY`, `VlCTORY` | 結果 `WIN` 送信 |
| **敗北** | `LOSE`, `L0SE`, `LDSE` | 結果 `LOSE` 送信 |
| **除外** | `CLOSE` | 誤検知防止のため無視 |

---

## 6. ディレクトリ構成 (VS Code)

```
md-tracker/
├── index.html       # フロントエンド構造 (HTML5)
├── style.css        # デザイン・PiPスタイル (CSS3)
├── script.js        # アプリケーションロジック (JS)
└── gas/             # バックエンド (CLASP管理)
    ├── .clasp.json  # CLASP設定ファイル
    ├── appsscript.json
    └── コード.js    # GAS APIロジック
```

---

## 7. 通信仕様

- **プロトコル:** JSONP (Cross-Origin Resource Sharing回避のため)
- **GETリクエスト:** データの取得 (`action` 指定なし)
- **POSTリクエスト:** データの送信・更新 (`action` パラメータで分岐)
    - `record`: 新規記録
    - `update_log`: 記録の修正
    - `delete_log`: 記録の削除
    - `add_deck`: デッキリスト追加

---

## 8. セットアップ手順

### 8.1. バックエンド (Google Apps Script)

1. 新しい**Googleスプレッドシート**を作成。
   - 最初のシートを `Log` に名前変更。
   - 2つ目のシートを `Config` に名前変更。
2. **拡張機能 > Apps Script**を開く。
3. `gas/コード.js` の内容をスクリプトエディタにコピー。
4. **Webアプリとして公開:**
   - **デプロイ > 新しいデプロイ**をクリック。
   - タイプ: **ウェブアプリ**。
   - 説明: `MD Tracker Backend`。
   - 次のユーザーとして実行: **自分**。
   - アクセスできるユーザー: **全員**（フロントエンドからのアクセスに必要）。
   - **デプロイ**をクリックしてURLをコピー。

### 8.2. フロントエンド

1. `index.html` をブラウザで開く。
2. 初回起動時、**GAS WebアプリURL**の入力を求められるので、先ほどコピーしたURLを貼り付ける。
3. **保存**をクリック。

---

## 9. 使用方法

1. **デッキ選択:** 使用するデッキをドロップダウンから選択。
2. **監視開始:** 「画面監視を開始」ボタンをクリック。
3. **ウィンドウ選択:** 「Master Duel」のウィンドウを選択して共有。
   - ※ゲームウィンドウを最小化しないでください。
4. **プレイ:** トラッカーが自動的に以下を検知します:
   - コイントス結果(表/裏)。
   - 手番(先攻/後攻)。
   - 試合結果(勝利/敗北)。
5. **分析:** 「分析モード」タブに切り替えて統計情報を確認。

---

## 10. トラブルシューティング

- **CORS エラー:** GAS Webアプリが「アクセスできるユーザー: 全員」で公開されているか確認してください。
- **OCR が動作しない:** ゲームウィンドウがクリアで、テキストが見やすいことを確認してください。OCRは標準のゲームフォント用に調整されています。
